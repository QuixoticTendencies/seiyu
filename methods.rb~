require 'rubygems'
require 'nokogiri'
require 'open-uri'

seiyuurl = ARGV[0]
un = ARGV[1] || 'default_user'

seiyu = Nokogiri::HTML(open(seiyuurl))
mal = Nokogiri::XML(open('http://myanimelist.net/malappinfo.php?u=' + un + '&status=all&type=anime'))
seiyu_shows = seiyu.css('table:nth-child(4) .borderClass:nth-child(2) > a')
seiyu_roles = seiyu.css('.borderClass~ .borderClass+ .borderClass > a')
mal_shows = mal.xpath("//series_title")
seiyu_shows_ar = Array.new()
seiyu_roles_ar = Array.new()
mal_shows_text = Array.new()
for i in 0..(seiyu_shows.length - 1) do
	seiyu_shows_ar[i] = seiyu_shows[i].text
	seiyu_roles_ar[i] = seiyu_roles[i].text
end
for i in 0..(mal_shows.length - 1) do
	mal_shows_text[i] = mal_shows[i].text
end
seiyu_hash = Hash[seiyu_shows_ar.zip(seiyu_roles_ar)]
#=>mal_shows_text = mal_shows.map{|x| x.text}
noncolliding_shows = seiyu_shows_ar - mal_shows_text
colliding_shows = seiyu_shows_ar - noncolliding_shows
output = Array.new()
for i in 0..(colliding_shows.length - 1) do
	output[i] = colliding_shows[i] + ' - ' + seiyu_hash[colliding_shows[i]]
end

if un == 'default_user' then
	for i in 0..(seiyu_shows_ar.length - 1) do
		output[i] = seiyu_shows_ar[i] + ' - ' + seiyu_roles[i]
	end
end
puts output.join("\n")

=begin
def pop_ar_sei(url, r)
	page = Nokogiri::HTML(open(url))
	shows = page.css('table:nth-child(4) .borderClass:nth-child(2) > a')
	roles = page.css('.borderClass~ .borderClass+ .borderClass > a')
	zipped = Array.new(shows.length)
	i = 0
	shows.zip(roles).each do |x,y|
		i += 1
		zipped[i] = x.text + ' - ' +  y.text
	end
	list = Array.new()
	for i in 0..(shows.length - 1) do
		list[i] = shows[i].text
	end
	r ||= 1
	if r == 1 then
		ret = zipped
	else
		ret = list
	end
	return ret
end

def pop_ar_mal(un)
	url = 'http://myanimelist.net/malappinfo.php?u='+ un + '&status=all&type=anime'
	page = Nokogiri::HTML(open(url))
	mal = page.xpath("//series_title")
	smal = Array.new()
	for i in 0..(mal.length - 1) do
		smal[i] = mal[i].text
	end
	smal = smal.sort
	return smal
end

def pop_ar_col(url, un)
	mal = Array.new()
	sei = Array.new()
	inv = Array.new()
	col = Array.new()
	mal = pop_ar_mal(un)
	sei = pop_ar_sei(url, 2)
	inv = sei - mal
	col = sei - inv
	return col
end

puts pop_ar_col('http://myanimelist.net/people/599/Aki_Toyosaki', 'quixten')
=end
